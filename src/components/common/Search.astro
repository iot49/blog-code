---
import { fetchPosts } from '~/utils/blog';

const allPosts = await fetchPosts();

const searchData = allPosts.map((post) => ({
  title: post.title,
  excerpt: post.accessLevel === 'public' ? post.excerpt || '' : '',
  permalink: post.permalink,
  tags: post.tags?.map((tag) => tag.title) || [],
  accessLevel: post.accessLevel,
}));

const searchDataJson = JSON.stringify(searchData);
---

<div class="search-container" data-search={searchDataJson}>
  <input type="search" id="search-input" placeholder="Search posts..." class="search-input" aria-label="Search posts" />
  <div id="search-results" class="search-results hidden"></div>
</div>

<script>
  import Fuse from 'fuse.js';

  const container = document.querySelector('.search-container') as HTMLElement;

  interface SearchItem {
    title: string;
    excerpt: string;
    permalink: string;
    tags: string[];
    accessLevel: string;
  }

  const searchData: SearchItem[] = JSON.parse(container.dataset.search ?? '[]');

  const fuse = new Fuse<SearchItem>(searchData, {
    keys: ['title', 'excerpt', 'tags'],
    threshold: 0.3,
    includeScore: true,
  });

  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;

    if (query.length < 2) {
      searchResults!.classList.add('hidden');
      return;
    }

    const results = fuse.search(query).slice(0, 5);

    if (results.length === 0) {
      searchResults!.innerHTML = '<div class="no-results">No results found</div>';
      searchResults!.classList.remove('hidden');
      return;
    }

    searchResults!.innerHTML = results
      .map(
        (result) => `
      <a href="${result.item.permalink}" class="search-result-item">
        <div class="flex items-center gap-2">
          <strong>${result.item.title}</strong>
          ${
            result.item.accessLevel !== 'public'
              ? `<span class="text-gray-400" title="Protected content"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-lock"><path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z"></path><path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path><path d="M8 11v-4a4 4 0 1 1 8 0v4"></path></svg></span>`
              : ''
          }
        </div>
        ${result.item.excerpt ? `<p>${result.item.excerpt}</p>` : ''}
      </a>
    `
      )
      .join('');

    searchResults!.classList.remove('hidden');
  });

  // Close results when clicking outside
  document.addEventListener('click', (e) => {
    if (!(e.target as Element).closest('.search-container')) {
      searchResults!.classList.add('hidden');
    }
  });
</script>

<style>
  .search-container {
    position: relative;
    max-width: 400px;
  }

  .search-input {
    width: 100%;
    padding: 0.5rem 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
    font-size: 0.875rem;
  }

  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 400px;
    overflow-y: auto;
    z-index: 50;
  }

  .search-results.hidden {
    display: none;
  }

  .search-result-item {
    display: block;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    text-decoration: none;
    color: inherit;
  }

  .search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item strong {
    display: block;
    margin-bottom: 0.25rem;
  }

  .search-result-item p {
    font-size: 0.875rem;
    color: rgba(0, 0, 0, 0.6);
    margin: 0;
  }

  .no-results {
    padding: 1rem;
    text-align: center;
    color: rgba(0, 0, 0, 0.5);
  }
</style>
