---
import { fetchPosts } from '~/utils/blog';
import { getPermalink } from '~/utils/permalinks';
import { Icon } from 'astro-icon/components';

const allPosts = await fetchPosts();

const searchData = allPosts.map((post) => ({
  title: post.title,
  excerpt: post.accessLevel === 'public' ? post.excerpt || '' : '',
  permalink: getPermalink(post.permalink, 'post'),
  tags: post.tags?.map((tag) => tag.title) || [],
  accessLevel: post.accessLevel,
}));

const searchDataJson = JSON.stringify(searchData);
---

<div class="search-modal-trigger">
  <button
    id="search-open"
    aria-label="Search"
    class="flex items-center justify-center w-8 h-8 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm"
  >
    <Icon name="tabler:search" class="w-5 h-5" />
  </button>
</div>

<dialog id="search-modal" class="search-modal" aria-labelledby="search-modal-title">
  <div class="search-modal-content">
    <div class="search-modal-header">
      <h2 id="search-modal-title" class="sr-only">Search</h2>
      <div class="relative w-full">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <Icon name="tabler:search" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
        </div>
        <input
          type="search"
          id="modal-search-input"
          class="block w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
          placeholder="Search posts..."
          required
        />
      </div>
      <button
        id="search-close"
        aria-label="Close search"
        class="ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
      >
        <Icon name="tabler:x" class="w-6 h-6" />
      </button>
    </div>
    <div id="modal-search-results" class="search-modal-results"></div>
    <div class="search-modal-footer text-xs text-gray-500 dark:text-gray-400">
      Press <kbd>ESC</kbd> to close
    </div>
  </div>
  <div class="search-data" data-search={searchDataJson} style="display: none;"></div>
</dialog>

<script>
  import Fuse from 'fuse.js';

  interface SearchItem {
    title: string;
    excerpt: string;
    permalink: string;
    tags: string[];
    accessLevel: string;
  }

  let fuse: Fuse<SearchItem> | null = null;

  function initSearch() {
    if (fuse) return;
    const searchDataContainer = document.querySelector('.search-data') as HTMLElement;
    const searchData: SearchItem[] = JSON.parse(searchDataContainer?.dataset.search ?? '[]');
    fuse = new Fuse<SearchItem>(searchData, {
      keys: ['title', 'excerpt', 'tags'],
      threshold: 0.3,
      includeScore: true,
      ignoreLocation: true,
    });
  }

  function attachEvents() {
    const modal = document.getElementById('search-modal') as HTMLDialogElement;
    const openBtn = document.getElementById('search-open');
    const closeBtn = document.getElementById('search-close');
    const searchInput = document.getElementById('modal-search-input') as HTMLInputElement;
    const searchResults = document.getElementById('modal-search-results');

    if (!modal || !openBtn || !closeBtn || !searchInput || !searchResults) return;

    function openModal() {
      initSearch();
      modal?.showModal();
      document.body.style.overflow = 'hidden';
      searchInput?.focus();
    }

    function closeModal() {
      modal?.close();
      document.body.style.overflow = '';
      if (searchInput) searchInput.value = '';
      if (searchResults) searchResults.innerHTML = '';
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;

      if (!fuse || !searchResults) return;

      if (query.length < 2) {
        searchResults.innerHTML = '';
        return;
      }

      const results = fuse.search(query).slice(0, 10);

      if (results.length === 0) {
        searchResults.innerHTML =
          '<div class="p-4 text-center text-gray-500 dark:text-gray-400">No results found</div>';
        return;
      }

      searchResults.innerHTML = results
        .map(
          (result) => `
        <a href="${result.item.permalink}" class="block p-4 hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 last:border-0">
          <div class="flex items-center gap-2">
            <div class="text-base font-semibold text-gray-900 dark:text-white">${result.item.title}</div>
            ${
              result.item.accessLevel !== 'public'
                ? `<span class="text-gray-400" title="Protected content"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-lock"><path d="M5 11m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z"></path><path d="M12 16m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path><path d="M8 11v-4a4 4 0 1 1 8 0v4"></path></svg></span>`
                : ''
            }
          </div>
          ${result.item.excerpt ? `<p class="mt-1 text-sm text-gray-500 dark:text-gray-400 line-clamp-2">${result.item.excerpt}</p>` : ''}
        </a>
      `
        )
        .join('');
    });
  }

  document.addEventListener('astro:page-load', attachEvents);
</script>

<style>
  .search-modal {
    padding: 0;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    max-width: 100%;
    width: 100%;
    height: 100%;
    max-height: 100%;
  }

  .search-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  .search-modal-content {
    background: white;
    width: 600px;
    max-width: 90vw;
    margin: 10vh auto;
    border-radius: 0.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    max-height: 80vh;
  }

  :global(.dark) .search-modal-content {
    background: #1f2937;
    border: 1px solid #374151;
  }

  .search-modal-header {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  :global(.dark) .search-modal-header {
    border-bottom-color: #374151;
  }

  .search-modal-results {
    flex: 1;
    overflow-y: auto;
    min-height: 200px;
  }

  .search-modal-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
  }

  :global(.dark) .search-modal-footer {
    background: #111827;
    border-top-color: #374151;
  }
</style>
