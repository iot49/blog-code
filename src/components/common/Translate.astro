---
import { Icon } from 'astro-icon/components';

/**
 * Translate component
 * Renders a button that opens Google Translate for the current page.
 * This approach is privacy-preserving as it only connects to Google on click.
 */

const {
  class:
    className = 'text-muted dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center',
} = Astro.props;

// We'll use a client-side script to get the current URL
---

<div class="flex items-center gap-1">
  <button
    id="translate-button-en"
    class:list={[className, 'px-2 py-1 text-xs font-semibold uppercase']}
    aria-label="Translate to English"
    title="Translate to English"
    data-lang="en"
  >
    EN
  </button>
  <button
    id="translate-button-de"
    class:list={[className, 'px-2 py-1 text-xs font-semibold uppercase']}
    aria-label="Translate to German"
    title="Translate to German"
    data-lang="de"
  >
    DE
  </button>
  <button
    id="translate-button-fr"
    class:list={[className, 'px-2 py-1 text-xs font-semibold uppercase']}
    aria-label="Translate to French"
    title="Translate to French"
    data-lang="fr"
  >
    FR
  </button>
  <button id="translate-button" class={className} aria-label="Translate this page" title="Translate this page">
    <Icon name="tabler:language" class="w-5 h-5" />
  </button>
</div>

<script>
  function attachTranslate() {
    const defaultBtn = document.getElementById('translate-button');
    const langBtns = document.querySelectorAll<HTMLButtonElement>('[data-lang]');

    if (defaultBtn) {
      defaultBtn.addEventListener('click', () => {
        if (window.location.hostname.includes('translate.goog')) return;
        const currentUrl = window.location.href;
        const translateUrl = `https://translate.google.com/translate?u=${encodeURIComponent(currentUrl)}`;
        window.open(translateUrl, '_blank');
      });
    }

    langBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const lang = btn.dataset.lang;
        const url = new URL(window.location.href);

        if (url.hostname.includes('translate.goog')) {
          // Already on a translated page, just change the target language
          url.searchParams.set('_x_tr_tl', lang || '');
          window.location.href = url.toString();
        } else {
          // New translation, open in a new tab
          const translateUrl = `https://translate.google.com/translate?sl=auto&tl=${lang}&u=${encodeURIComponent(window.location.href)}`;
          window.open(translateUrl, '_blank');
        }
      });
    });
  }

  // Handle initial load and View Transitions
  attachTranslate();
  document.addEventListener('astro:after-swap', attachTranslate);
</script>
