#!/usr/bin/env python3
"""
bin/migrate-images

Finds images stored next to posts (in images/ subdirectories) and:
  1. Moves them to src/assets/images/posts/<post-slug>/
  2. Rewrites the markdown image references to use ~/assets/... paths
     which Astro can optimise during build.

VS Code naturally pastes clipboard images as:
  ![alt](<images/post-name/image.png>)

After migration the markdown becomes:
  ![alt](~/assets/images/posts/post-name/image.png)

Run automatically by bin/deploy before the build step.
Safe to run multiple times (idempotent).
"""

import re
import shutil
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).parent.parent
POST_DIR = REPO_ROOT / "src" / "data" / "post"
ASSETS_DIR = REPO_ROOT / "src" / "assets" / "images" / "posts"

RESET = "\033[0m"
GREEN = "\033[0;32m"
CYAN = "\033[0;36m"
YELLOW = "\033[1;33m"
DIM = "\033[2m"


def info(msg):
    print(f"{CYAN}  →{RESET} {msg}")


def warn(msg):
    print(f"{YELLOW}  ⚠{RESET}  {msg}")


# Matches both:
#   ![alt](<images/foo bar/img.png>)   ← angle-bracket form (spaces in path)
#   ![alt](images/foo/img.png)         ← plain form
IMAGE_RE = re.compile(
    r'(!\[[^\]]*\])\((?:<(images/[^>]+)>|(images/[^\s)]+))\)'
)


def migrate_post(md_file: Path) -> int:
    """Migrate images in a single post. Returns number of images migrated."""
    content = md_file.read_text(encoding="utf-8")
    matches = list(IMAGE_RE.finditer(content))
    if not matches:
        return 0

    changed = 0
    new_content = content

    for m in matches:
        alt_part = m.group(1)          # e.g. ![Illertal layout]
        rel_path = m.group(2) or m.group(3)  # e.g. images/foo bar/img.png

        src_image = md_file.parent / rel_path

        if not src_image.exists():
            warn(f"Image not found, skipping: {src_image.relative_to(REPO_ROOT)}")
            continue

        # Destination: src/assets/images/posts/<image-subdir>/<filename>
        # Strip the leading "images/" prefix from rel_path
        sub = Path(rel_path).relative_to("images")   # e.g. foo bar/img.png
        dest_image = ASSETS_DIR / sub

        dest_image.parent.mkdir(parents=True, exist_ok=True)

        if not dest_image.exists():
            shutil.move(str(src_image), str(dest_image))
            info(f"Moved  {src_image.relative_to(REPO_ROOT)}")
            info(f"    →  {dest_image.relative_to(REPO_ROOT)}")
        else:
            # Already migrated — just remove the source copy if it still exists
            src_image.unlink(missing_ok=True)
            info(f"Already in assets, removed source: {src_image.relative_to(REPO_ROOT)}")

        # Rewrite path in markdown: ~/assets/images/posts/<sub>
        asset_path = f"~/assets/images/posts/{sub.as_posix()}"
        old_ref = m.group(0)
        new_ref = f"{alt_part}({asset_path})"
        new_content = new_content.replace(old_ref, new_ref, 1)
        changed += 1

    if changed:
        md_file.write_text(new_content, encoding="utf-8")
        # Clean up empty images/ subdirs
        images_dir = md_file.parent / "images"
        if images_dir.exists():
            for d in sorted(images_dir.rglob("*"), reverse=True):
                if d.is_dir():
                    try:
                        d.rmdir()  # only removes if empty
                    except OSError:
                        pass
            try:
                images_dir.rmdir()
            except OSError:
                pass

    return changed


def main():
    total = 0
    posts = list(POST_DIR.glob("*.md")) + list(POST_DIR.glob("*.mdx"))

    for md_file in sorted(posts):
        n = migrate_post(md_file)
        if n:
            print(f"{GREEN}✓{RESET} {md_file.name}: migrated {n} image(s)")
        total += n

    if total == 0:
        print(f"  {DIM}No images to migrate.{RESET}")
    else:
        print(f"\n{GREEN}✓{RESET} Migrated {total} image(s) total.")

    return 0


if __name__ == "__main__":
    sys.exit(main())
