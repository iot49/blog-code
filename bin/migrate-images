#!/usr/bin/env python3
"""
bin/migrate-images

Finds images stored next to posts (in images/ subdirectories) and:
  1. Moves them to src/assets/images/posts/<post-slug>/
  2. Rewrites the markdown image references to a relative path from the
     post file to src/assets/, e.g. ../../assets/images/posts/foo/img.png
     This works for both VS Code markdown preview and Astro's build.

VS Code naturally pastes clipboard images as:
  ![alt](<images/post-name/image.png>)

After migration the markdown becomes:
  ![alt](<../../assets/images/posts/post-name/image.png>)

Also normalises any existing ~/assets/ references to relative paths.

Run automatically by bin/deploy before the build step.
Safe to run multiple times (idempotent).
"""

import os
import re
import shutil
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).parent.parent
POST_DIR = REPO_ROOT / "src" / "data" / "post"
ASSETS_DIR = REPO_ROOT / "src" / "assets" / "images" / "posts"

RESET = "\033[0m"
GREEN = "\033[0;32m"
CYAN = "\033[0;36m"
YELLOW = "\033[1;33m"
DIM = "\033[2m"


def info(msg):
    print(f"{CYAN}  →{RESET} {msg}")


def warn(msg):
    print(f"{YELLOW}  ⚠{RESET}  {msg}")


# Matches image refs in three forms:
#   ![alt](<images/foo bar/img.png>)          ← angle-bracket, spaces (VS Code paste)
#   ![alt](images/foo/img.png)                ← plain relative (VS Code paste, no spaces)
#   ![alt](~/assets/images/posts/foo/img.png) ← old ~/assets form (normalise to relative)
IMAGE_RE = re.compile(
    r"(!\[[^\]]*\])\("
    r"(?:"
    r"<(images/[^>]+)>"              # group 2: angle-bracket images/ path
    r"|(images/[^\s)]+)"             # group 3: plain images/ path
    r"|~/assets/images/posts/([^)]+)"  # group 4: ~/assets/ path
    r")\)"
)


# Matches the frontmatter `image:` field in these forms:
#   image: images/foo bar/img.png          ← VS Code paste (relative, no assets prefix)
#   image: ../../assets/images/posts/...   ← relative to src/assets (after body migration)
# Does NOT match:
#   image: ~/assets/...                    ← already correct, leave alone
#   image: https://...                     ← external URL, leave alone
FRONTMATTER_IMAGE_RE = re.compile(
    r"^(image:\s*)"
    r"(?!"                              # negative lookahead — skip already-correct forms
    r"~/assets/"
    r"|https?://"
    r"|/)"
    r"(.+)$",                           # group 2: the raw path
    re.MULTILINE,
)


def fix_frontmatter_image(md_file: Path, content: str) -> tuple[str, int]:
    """
    Normalise the frontmatter `image:` field.
    Moves the image file to src/assets/ if needed and rewrites the path
    to ~/assets/images/posts/... (the format findImage() expects).
    Returns (new_content, number_of_changes).
    """
    m = FRONTMATTER_IMAGE_RE.search(content)
    if not m:
        return content, 0

    prefix = m.group(1)   # "image: "
    raw = m.group(2).strip()

    # Resolve the source image path relative to the post file
    src_image = (md_file.parent / raw).resolve()

    if not src_image.exists():
        warn(f"frontmatter image not found, skipping: {raw}")
        return content, 0

    # Work out the destination under src/assets/images/posts/
    # Strip any leading "images/" or "../../assets/images/posts/" prefix
    rel = Path(raw)
    try:
        sub = rel.relative_to("images")          # images/foo/img.png → foo/img.png
    except ValueError:
        try:
            # ../../assets/images/posts/foo/img.png → foo/img.png
            sub = Path(os.path.relpath(src_image, ASSETS_DIR))
        except ValueError:
            sub = Path(src_image.name)

    dest_image = ASSETS_DIR / sub
    dest_image.parent.mkdir(parents=True, exist_ok=True)

    if not dest_image.exists():
        shutil.move(str(src_image), str(dest_image))
        info(f"Moved  (frontmatter) {src_image.relative_to(REPO_ROOT)}")
        info(f"    →  {dest_image.relative_to(REPO_ROOT)}")
    elif src_image != dest_image:
        src_image.unlink(missing_ok=True)

    # Rewrite to ~/assets/ path (required by findImage())
    asset_path = f"~/assets/images/posts/{sub.as_posix()}"
    new_content = content[: m.start()] + f"{prefix}{asset_path}" + content[m.end() :]
    info(f"Frontmatter image: {raw!r} → {asset_path!r}")
    return new_content, 1


def migrate_post(md_file: Path) -> int:
    """Migrate images in a single post. Returns number of images migrated."""
    content = md_file.read_text(encoding="utf-8")

    changed = 0
    new_content = content

    # Fix frontmatter image: field first
    new_content, fm_changed = fix_frontmatter_image(md_file, new_content)
    changed += fm_changed

    # Fix body image references
    matches = list(IMAGE_RE.finditer(new_content))
    if not matches and not fm_changed:
        return 0

    for m in matches:
        alt_part = m.group(1)  # e.g. ![Illertal layout]

        if m.group(4):
            # Already a ~/assets/ path — normalise to relative (no file move needed)
            sub = Path(m.group(4))  # e.g. "2026-02-17 foo/image.png"
            dest_image = ASSETS_DIR / sub
            if not dest_image.exists():
                warn(f"~/assets/ image not found, skipping: {dest_image.relative_to(REPO_ROOT)}")
                continue
        else:
            rel_path = m.group(2) or m.group(3)  # e.g. images/foo bar/img.png
            src_image = md_file.parent / rel_path

            if not src_image.exists():
                warn(f"Image not found, skipping: {src_image.relative_to(REPO_ROOT)}")
                continue

            # Destination: src/assets/images/posts/<subpath>
            sub = Path(rel_path).relative_to("images")  # e.g. foo bar/img.png
            dest_image = ASSETS_DIR / sub
            dest_image.parent.mkdir(parents=True, exist_ok=True)

            if not dest_image.exists():
                shutil.move(str(src_image), str(dest_image))
                info(f"Moved  {src_image.relative_to(REPO_ROOT)}")
                info(f"    →  {dest_image.relative_to(REPO_ROOT)}")
            else:
                src_image.unlink(missing_ok=True)
                info(f"Already in assets, removed source: {src_image.relative_to(REPO_ROOT)}")

        # Rewrite to a relative path from the post file.
        # Works in both VS Code markdown preview and Astro build.
        rel_to_post = Path(os.path.relpath(dest_image, md_file.parent)).as_posix()
        if " " in rel_to_post:
            asset_path = f"<{rel_to_post}>"
        else:
            asset_path = rel_to_post

        old_ref = m.group(0)
        new_ref = f"{alt_part}({asset_path})"
        if old_ref != new_ref:
            new_content = new_content.replace(old_ref, new_ref, 1)
            changed += 1

    if changed:
        md_file.write_text(new_content, encoding="utf-8")
        # Clean up empty images/ subdirs
        images_dir = md_file.parent / "images"
        if images_dir.exists():
            for d in sorted(images_dir.rglob("*"), reverse=True):
                if d.is_dir():
                    try:
                        d.rmdir()
                    except OSError:
                        pass
            try:
                images_dir.rmdir()
            except OSError:
                pass

    return changed


def main():
    total = 0
    posts = list(POST_DIR.glob("*.md")) + list(POST_DIR.glob("*.mdx"))

    for md_file in sorted(posts):
        n = migrate_post(md_file)
        if n:
            print(f"{GREEN}✓{RESET} {md_file.name}: migrated {n} image(s)")
        total += n

    if total == 0:
        print(f"  {DIM}No images to migrate.{RESET}")
    else:
        print(f"\n{GREEN}✓{RESET} Migrated {total} image(s) total.")

    return 0


if __name__ == "__main__":
    sys.exit(main())
