#!/usr/bin/env bash
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

pass() { echo -e "${GREEN}✓${RESET} $1"; }
fail() { echo -e "${RED}✗${RESET} $1"; }
info() { echo -e "${CYAN}▶${RESET} $1"; }
warn() { echo -e "${YELLOW}⚠${RESET} $1"; }

echo -e "\n${BOLD}=== Pre-deploy checks ===${RESET}\n"

ERRORS=0

# ── 1. Uncommitted changes ────────────────────────────────────────────────────
info "Checking for uncommitted changes..."
if [[ -n "$(git status --porcelain)" ]]; then
  warn "You have uncommitted changes. They will NOT be included in this deploy."
  git status --short
  echo ""
fi

# ── 2. Prettier ───────────────────────────────────────────────────────────────
info "Prettier (formatting check)..."
if npm run check:prettier --silent 2>&1; then
  pass "Prettier"
else
  fail "Prettier — run 'npm run fix:prettier' to auto-fix"
  ERRORS=$((ERRORS + 1))
fi

# ── 3. ESLint ─────────────────────────────────────────────────────────────────
info "ESLint..."
if npm run check:eslint --silent 2>&1; then
  pass "ESLint"
else
  fail "ESLint — run 'npm run fix:eslint' to auto-fix where possible"
  ERRORS=$((ERRORS + 1))
fi

# ── 4. Astro type check ───────────────────────────────────────────────────────
info "Astro type check..."
if npm run check:astro --silent 2>&1; then
  pass "Astro type check"
else
  fail "Astro type check"
  ERRORS=$((ERRORS + 1))
fi

# ── 5. YAML frontmatter validation ────────────────────────────────────────────
info "YAML frontmatter in posts..."
YAML_ERRORS=0
while IFS= read -r -d '' file; do
  # Extract frontmatter between --- delimiters and validate with node
  if ! node --input-type=module <<EOF 2>/dev/null
import { readFileSync } from 'fs';
import { load } from '${REPO_ROOT}/node_modules/js-yaml/dist/js-yaml.mjs';
const content = readFileSync('${file}', 'utf8');
const match = content.match(/^---\n([\s\S]*?)\n---/);
if (match) load(match[1]);
EOF
  then
    fail "Bad YAML frontmatter: $file"
    YAML_ERRORS=$((YAML_ERRORS + 1))
  fi
done < <(find src/data/post -name "*.md" -o -name "*.mdx" | tr '\n' '\0')

if [[ $YAML_ERRORS -eq 0 ]]; then
  pass "YAML frontmatter"
else
  ERRORS=$((ERRORS + YAML_ERRORS))
fi

# ── 6. Migrate images (move from images/ next to posts → src/assets/) ────────
info "Migrating post images to src/assets/..."
python3 "$REPO_ROOT/bin/migrate-images"
# Stage any files the migration moved/rewrote
git add -A src/assets/images src/data/post 2>/dev/null || true

# ── 7. Build ──────────────────────────────────────────────────────────────────
info "Production build..."
if npm run build --silent 2>&1; then
  pass "Build"
else
  fail "Build failed"
  ERRORS=$((ERRORS + 1))
fi

# ── 7. Broken internal links (basic check on built output) ────────────────────
info "Checking for broken internal links in built output..."
LINK_ERRORS=0
if [[ -d dist ]]; then
  while IFS= read -r -d '' html; do
    # Use Python to extract internal hrefs (works on macOS and Linux)
    python3 - "$html" "$REPO_ROOT/dist" <<'PYEOF'
import sys, re
from pathlib import Path

html_file = Path(sys.argv[1])
dist = Path(sys.argv[2])

content = html_file.read_text(errors='ignore')
hrefs = re.findall(r'href="(/[^"#?]*)"', content)
for link in hrefs:
    candidates = [
        dist / link.lstrip('/'),
        dist / link.lstrip('/') / 'index.html',
        Path(str(dist / link.lstrip('/')) + '.html'),
    ]
    if not any(c.exists() for c in candidates):
        print(f"  Possibly broken: '{link}' in {html_file.name}")
PYEOF
  done < <(find dist -name "*.html" -print0)
fi
pass "Internal links (checked)"

# ── Summary ───────────────────────────────────────────────────────────────────
echo ""
if [[ $ERRORS -gt 0 ]]; then
  echo -e "${RED}${BOLD}✗ $ERRORS check(s) failed. Fix errors before deploying.${RESET}"
  echo -e "  Tip: run ${CYAN}npm run fix${RESET} to auto-fix formatting issues.\n"
  exit 1
fi

echo -e "${GREEN}${BOLD}✓ All checks passed!${RESET}\n"

# ── Push ──────────────────────────────────────────────────────────────────────
info "Pushing to GitHub..."
git push
echo -e "\n${GREEN}${BOLD}✓ Pushed. Cloudflare Pages will deploy shortly.${RESET}"
echo -e "  ${CYAN}https://blog-boser-guyon.pages.dev${RESET}\n"
